<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>習慣追蹤器 - 強度點數版</title>
    
    <style>
        body { font-family: Arial, sans-serif; max-width: 700px; margin: 40px auto; padding: 20px; text-align: center; background-color: #f4f4f9; }
        h1 { color: #2c3e50; border-bottom: 2px solid #bdc3c7; padding-bottom: 10px; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background-color: #ecf0f1; border-radius: 8px; }
        .half-life-selector label { font-weight: bold; color: #34495e; margin-right: 10px; }
        .half-life-selector select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .stats-box { border: 2px solid #3498db; padding: 15px; margin-bottom: 20px; border-radius: 10px; background-color: #ecf0f1; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sync-display { display: flex; justify-content: space-around; align-items: center; margin: 15px 0; padding: 10px; border-bottom: 1px dashed #ccc; }
        .display-item { flex: 1; padding: 0 10px; }
        .display-item h2 { margin: 0 0 5px 0; font-size: 1.2em; color: #34495e; }
        #timerDisplay, #scoreDisplay { font-size: 2.2em; font-weight: bold; font-family: 'Courier New', monospace; display: block; }
        #timerDisplay { color: #e74c3c; } 
        #scoreDisplay { color: #f39c12; } 
        .controls button { padding: 12px 25px; margin: 10px; font-size: 1.1em; cursor: pointer; border-radius: 6px; transition: background-color 0.3s; font-weight: bold; }
        #addButton { background-color: #2ecc71; color: white; border: none; }
        #deleteButton { background-color: #e74c3c; color: white; border: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9em;}
        th { background-color: #34495e; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <h1>習慣追蹤</h1>

    <div class="header-controls">
        <div class="half-life-selector">
            <label for="halfLifeSelector">半衰期:</label>
            <select id="halfLifeSelector">
                <option value="1">1 小時</option>
                <option value="2" selected>2 小時</option> 
            </select>
        </div>
        <div></div> 
    </div>

    <div class="stats-box">
        <p>今日 (以凌晨 4 點為分界): <strong id="currentDateDisplay"></strong></p>
        <p>今日累計執行次數: <strong id="dailyCountDisplay">0</strong> 次</p>
    </div>

    <div class="sync-display">
        <div class="display-item">
            <h2>自上次執行已過時間</h2>
            <span id="timerDisplay">00:00:00</span>
        </div>
        <div class="display-item">
            <h2>當前累積點數</h2>
            <span id="scoreDisplay">0.00</span>
        </div>
    </div>

    <div class="controls">
        <button id="addButton">✅ 新增紀錄</button> 
        <button id="deleteButton">❌ 刪除最近一筆</button> 
    </div>

    <h2>歷史紀錄明細</h2>
    <table>
        <thead>
            <tr>
                <th>日期</th>
                <th>時間戳記</th>
                <th>累積點數</th>
            </tr>
        </thead>
        <tbody id="historyTableBody">
        </tbody>
    </table>

    <script>
        // *** 關鍵變更：獨立的 STORAGE_KEYs ***
        const STORAGE_KEY = 'habit_timestamps_score'; 
        const STORAGE_HALF_LIFE_KEY = 'half_life_setting_score';
        const SHIFT_HOUR = 4;
        const INITIAL_SCORE = 100.0;

        // --- 取得 DOM 元素 ---
        const halfLifeSelector = document.getElementById('halfLifeSelector');
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const dailyCountDisplay = document.getElementById('dailyCountDisplay');
        const timerDisplay = document.getElementById('timerDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const addButton = document.getElementById('addButton');
        const deleteButton = document.getElementById('deleteButton');
        const historyTableBody = document.getElementById('historyTableBody');


        // --- 數據存取與載入 ---

        function loadTimestamps() {
            const json = localStorage.getItem(STORAGE_KEY);
            // 點數版紀錄格式：[{time: "ISO時間", score_at_creation: "175.00"}, ...]
            return json ? JSON.parse(json) : []; 
        }

        function saveTimestamps(timestamps) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(timestamps));
        }

        function loadHalfLifeHours() {
            const storedValue = localStorage.getItem(STORAGE_HALF_LIFE_KEY);
            return storedValue ? parseFloat(storedValue) : parseFloat(halfLifeSelector.value);
        }

        function saveHalfLifeHours(hours) {
            localStorage.setItem(STORAGE_HALF_LIFE_KEY, hours.toString());
        }


        // --- 核心邏輯：半衰期點數計算 (無變化) ---
        
        function calculateDecayedScore(timestampStr, initialScore, halfLifeHours, currentTime = new Date()) {
            const recordTime = new Date(timestampStr);
            const halfLifeMs = halfLifeHours * 60 * 60 * 1000;
            const timeElapsedMs = currentTime.getTime() - recordTime.getTime();
            const decayFactor = Math.pow(0.5, timeElapsedMs / halfLifeMs);
            return initialScore * decayFactor;
        }

        function calculateTotalCurrentScore(timestamps, halfLifeHours, currentTime = new Date()) {
            if (timestamps.length === 0) return 0.0;
            
            let totalScore = 0;
            for (const record of timestamps) {
                totalScore += calculateDecayedScore(record.time, INITIAL_SCORE, halfLifeHours, currentTime);
            }
            return totalScore;
        }
        
        function recalculateAllCreationScores(timestamps, newHalfLifeHours) {
             const recalculatedTimestamps = [];
             for (let i = 0; i < timestamps.length; i++) {
                 const currentRecord = timestamps[i];
                 let scoreAtCreation = INITIAL_SCORE;
                 
                 for (let j = 0; j < i; j++) {
                     const previousRecord = timestamps[j];
                     scoreAtCreation += calculateDecayedScore(
                         previousRecord.time, 
                         INITIAL_SCORE, 
                         newHalfLifeHours, 
                         new Date(currentRecord.time)
                     );
                 }

                 recalculatedTimestamps.push({
                     time: currentRecord.time,
                     score_at_creation: scoreAtCreation.toFixed(2) 
                 });
             }
             return recalculatedTimestamps;
        }

        // --- 其他輔助功能 (無變化) ---
        
        function getHabitDay(timestamp) {
            const adjustedTime = new Date(timestamp);
            if (adjustedTime.getHours() < SHIFT_HOUR) {
                adjustedTime.setDate(adjustedTime.getDate() - 1);
            }
            adjustedTime.setHours(0, 0, 0, 0); 
            return adjustedTime;
        }

        // --- 顯示更新功能 ---

        function updateDisplay() {
            const timestamps = loadTimestamps();
            const halfLifeHours = loadHalfLifeHours();
            const now = new Date();
            
            halfLifeSelector.value = halfLifeHours.toString(); 

            // ... (彙總數據計算)
            const currentHabitDay = getHabitDay(now);
            currentDateDisplay.textContent = currentHabitDay.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let dailyCount = 0;
            timestamps.forEach(record => {
                const entryTime = new Date(record.time);
                if (getHabitDay(entryTime).getTime() === currentHabitDay.getTime()) {
                    dailyCount++;
                }
            });
            dailyCountDisplay.textContent = dailyCount;


            // ... (計時器計算)
            let timeAgoText = '00:00:00';
            if (timestamps.length > 0) {
                const lastTimestamp = new Date(timestamps[timestamps.length - 1].time);
                const diffSeconds = Math.floor((now.getTime() - lastTimestamp.getTime()) / 1000); 
                
                const seconds = diffSeconds % 60;
                const minutes = Math.floor(diffSeconds / 60) % 60;
                const hours = Math.floor(diffSeconds / 3600);

                const pad = (num) => String(num).padStart(2, '0');
                timeAgoText = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            }
            timerDisplay.textContent = timeAgoText;

            // ... (當前累積點數計算)
            const currentTotalScore = calculateTotalCurrentScore(timestamps, halfLifeHours, now);
            scoreDisplay.textContent = currentTotalScore.toFixed(2);

            // ... (渲染表格)
            renderHistoryTable(timestamps);
        }

        function renderHistoryTable(timestamps) {
            historyTableBody.innerHTML = '';
            
            [...timestamps].reverse().forEach(record => {
                const ts = new Date(record.time);
                const row = historyTableBody.insertRow();
                
                row.insertCell(0).textContent = ts.toLocaleDateString('zh-TW');
                row.insertCell(1).textContent = ts.toLocaleTimeString('zh-TW');
                row.insertCell(2).textContent = record.score_at_creation || 'N/A'; 
            });
        }


        // --- 事件處理器 ---

        addButton.addEventListener('click', () => {
            const timestamps = loadTimestamps();
            const halfLifeHours = loadHalfLifeHours();
            
            const scoreBeforeAdd = calculateTotalCurrentScore(timestamps, halfLifeHours, new Date());
            const scoreAtCreation = scoreBeforeAdd + INITIAL_SCORE;
            
            timestamps.push({
                time: new Date().toISOString(),
                score_at_creation: scoreAtCreation.toFixed(2)
            }); 
            
            saveTimestamps(timestamps);
            updateDisplay();
        });

        deleteButton.addEventListener('click', () => {
            let timestamps = loadTimestamps();
            if (timestamps.length > 0) {
                timestamps.pop(); 
                saveTimestamps(timestamps);
                updateDisplay(); 
            } else {
                alert('沒有可以刪除的紀錄了！');
            }
        });

        halfLifeSelector.addEventListener('change', (event) => {
            const newHalfLifeHours = parseFloat(event.target.value);
            
            saveHalfLifeHours(newHalfLifeHours);
            
            const oldTimestamps = loadTimestamps();
            const recalculatedTimestamps = recalculateAllCreationScores(oldTimestamps, newHalfLifeHours);
            
            saveTimestamps(recalculatedTimestamps);
            
            updateDisplay(); 
        });

        // --- 初始化與持續更新 ---

        function initialize() {
            const storedHalfLife = loadHalfLifeHours();
            halfLifeSelector.value = storedHalfLife.toString();
            
            setInterval(updateDisplay, 1000); 
            updateDisplay(); 
        }

        initialize();
    </script>
</body>
</html>